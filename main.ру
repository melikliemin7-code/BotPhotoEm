import asyncio
import os
import io
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command, CommandStart
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext
from PIL import Image

TOKEN = os.getenv("BOT_TOKEN")
bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

class PhotoState(StatesGroup):
    first = State()
    second = State()

@dp.message(CommandStart())
async def start(message: types.Message):
    await message.answer("""
üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏.

üìå **–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π:**  
- –ö–æ–º–∞–Ω–¥–∞: /merge  
- –ü–µ—Ä–≤–∞—è —Ñ–æ—Ç–æ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ  
- –í—Ç–æ—Ä–∞—è —Ñ–æ—Ç–æ ‚Äî –¥–ª—è —Å–æ–≤–º–µ—â–µ–Ω–∏—è  

üé® **–≠—Ñ—Ñ–µ–∫—Ç—ã:**  
- /ai_grayscale ‚Äî —á–µ—Ä–Ω–æ-–±–µ–ª–æ–µ —Ñ–æ—Ç–æ  
- /ai_flip ‚Äî –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ  
- /ai_mirror ‚Äî –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ  

üîÑ /reset ‚Äî –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
""", parse_mode=types.ParseMode.MARKDOWN)

@dp.message(Command("reset"))
async def reset(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ. –û—Ç–ø—Ä–∞–≤—å –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.")
    await PhotoState.first.set()

@dp.message(Command("merge"))
async def merge_start(message: types.Message):
    await message.answer("–û—Ç–ø—Ä–∞–≤—å –ø–µ—Ä–≤—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.")
    await PhotoState.first.set()

@dp.message(PhotoState.first)
async def receive_first(message: types.Message, state: FSMContext):
    if not message.photo:
        return await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ.")
    await state.update_data(first_photo=message.photo[-1].file_id)
    await message.answer("–ü–µ—Ä–≤–∞—è —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –≤—Ç–æ—Ä—É—é.")
    await PhotoState.second.set()

@dp.message(PhotoState.second)
async def receive_second(message: types.Message, state: FSMContext):
    if not message.photo:
        return await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ.")
    data = await state.get_data()
    first_id = data["first_photo"]
    second_id = message.photo[-1].file_id

    await message.answer("üîß –û–±—ä–µ–¥–∏–Ω—è—é —Ñ–æ—Ç–æ...")
    first_bytes = await bot.download(first_id)
    second_bytes = await bot.download(second_id)

    img1 = Image.open(first_bytes).convert("RGBA")
    img2 = Image.open(second_bytes).convert("RGBA")
    img2 = img2.resize(img1.size)
    blended = Image.blend(img1, img2, alpha=0.5)

    buf = io.BytesIO()
    buf.name = "merged.png"
    blended.save(buf, format="PNG")
    buf.seek(0)
    await message.answer_photo(buf, caption="‚ú® –ì–æ—Ç–æ–≤–æ!")
    await state.clear()

async def get_image_from_reply(message: types.Message):
    if not message.reply_to_message or not message.reply_to_message.photo:
        await message.answer("–û—Ç–≤–µ—Ç—å —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ —Ñ–æ—Ç–æ.")
        return None
    file_id = message.reply_to_message.photo[-1].file_id
    bio = await bot.download(file_id)
    bio.seek(0)
    img = Image.open(bio).convert("RGBA")
    return img

@dp.message(Command("ai_grayscale"))
async def ai_grayscale(message: types.Message):
    img = await get_image_from_reply(message)
    if img is None:
        return
    gray = img.convert("L").convert("RGBA")
    buf = io.BytesIO()
    buf.name = "gray.png"
    gray.save(buf, format="PNG")
    buf.seek(0)
    await message.answer_photo(buf, caption="üñ§ –ß/–ë —Ñ–æ—Ç–æ –≥–æ—Ç–æ–≤–æ")

@dp.message(Command("ai_flip"))
async def ai_flip(message: types.Message):
    img = await get_image_from_reply(message)
    if img is None:
        return
    flipped = img.transpose(Image.FLIP_TOP_BOTTOM)
    buf = io.BytesIO()
    buf.name = "flip.png"
    flipped.save(buf, format="PNG")
    buf.seek(0)
    await message.answer_photo(buf, caption="üîÑ –§–æ—Ç–æ –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ")

@dp.message(Command("ai_mirror"))
async def ai_mirror(message: types.Message):
    img = await get_image_from_reply(message)
    if img is None:
        return
    mirrored = img.transpose(Image.FLIP_LEFT_RIGHT)
    buf = io.BytesIO()
    buf.name = "mirror.png"
    mirrored.save(buf, format="PNG")
    buf.seek(0)
    await message.answer_photo(buf, caption="ü™û –§–æ—Ç–æ –∑–µ—Ä–∫–∞–ª—å–Ω–æ")

async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
