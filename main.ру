import os
import logging
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from PIL import Image
from io import BytesIO

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ: —Ç–æ–∫–µ–Ω –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–¥–µ)
TOKEN = os.getenv("TOKEN")

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

user_photos = {}

def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n"
        "–•–æ—á–µ—à—å —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ñ–æ—Ç–æ —Å–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å—é? üï∫\n"
        "–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ—ë —Ñ–æ—Ç–æ –ø–µ—Ä–≤—ã–º, –∞ –ø–æ—Ç–æ–º —Ñ–æ—Ç–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–∏ ‚Äî –∏ —è –∏—Ö –æ–±—ä–µ–¥–∏–Ω—é!"
    )
    user_photos[update.message.from_user.id] = []

def handle_photo(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    if user_id not in user_photos:
        user_photos[user_id] = []

    photo_file = update.message.photo[-1].get_file()
    bio = BytesIO()
    photo_file.download(out=bio)
    bio.seek(0)
    user_photos[user_id].append(Image.open(bio))

    if len(user_photos[user_id]) == 2:
        img1, img2 = user_photos[user_id]

        # –ü–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –≤—ã—Å–æ—Ç—É
        img1 = img1.resize((512, 512))
        img2 = img2.resize((512, 512))

        # –°–æ–µ–¥–∏–Ω—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
        combined = Image.new("RGB", (1024, 512))
        combined.paste(img1, (0, 0))
        combined.paste(img2, (512, 0))

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        output = BytesIO()
        output.name = "combined.jpg"
        combined.save(output, "JPEG", quality=95)
        output.seek(0)
        update.message.reply_photo(photo=output, caption="–í–æ—Ç –≤–∞—à–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è üåü")

        user_photos[user_id] = []
    else:
        update.message.reply_text("–§–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –≤—Ç–æ—Ä–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å—é).")

def error(update: Update, context: CallbackContext):
    logger.warning(f"Update {update} caused error {context.error}")

def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.photo, handle_photo))
    dp.add_error_handler(error)
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
