import logging
from telegram.ext import Updater, MessageHandler, Filters, CommandHandler
from telegram import Update
from telegram.ext import CallbackContext
from PIL import Image
import os

logging.basicConfig(level=logging.INFO)
user_photos = {}

# ---- START ----
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n"
        "–•–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ñ–æ—Ç–æ —Å–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å—é?\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ –¥–≤–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–æ–¥—Ä—è–¥:\n"
        "1Ô∏è‚É£ –¢–≤–æ—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è\n"
        "2Ô∏è‚É£ –§–æ—Ç–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–∏\n\n"
        "–Ø –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–æ–µ–¥–∏–Ω—é –∏—Ö –≤ –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø—Ä–∏—à–ª—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üòéüì∏"
    )

# ---- RESET ----
def reset(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    user_photos[user_id] = []
    update.message.reply_text("–ì–æ—Ç–æ–≤–æ! –û—Ç–ø—Ä–∞–≤—å –¥–≤–µ –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ üòä")

# ---- –û–ë–†–ê–ë–û–¢–ö–ê –§–û–¢–û ----
def handle_photo(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id

    if user_id not in user_photos:
        user_photos[user_id] = []

    # –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ
    file = update.message.photo[-1].get_file()
    file_path = f"{user_id}_{len(user_photos[user_id])}.jpg"
    file.download(file_path)

    user_photos[user_id].append(file_path)

    # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –æ–¥–Ω–æ ‚Äî –∂–¥—ë–º –≤—Ç–æ—Ä–æ–µ
    if len(user_photos[user_id]) == 1:
        update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –≤—Ç–æ—Ä—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é üì∏")
        return

    # –ï—Å–ª–∏ –¥–≤–∞ —Ñ–æ—Ç–æ ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º
    if len(user_photos[user_id]) == 2:
        try:
            img1 = Image.open(user_photos[user_id][0])
            img2 = Image.open(user_photos[user_id][1])

            # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ
            h = min(img1.height, img2.height)
            img1 = img1.resize((int(img1.width * h / img1.height), h))
            img2 = img2.resize((int(img2.width * h / img2.height), h))

            # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
            combined_width = img1.width + img2.width
            result = Image.new("RGB", (combined_width, h))
            result.paste(img1, (0, 0))
            result.paste(img2, (img1.width, 0))

            output_path = f"{user_id}_result.jpg"
            result.save(output_path, quality=95)

            # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            update.message.reply_photo(photo=open(output_path, "rb"))

        except Exception as e:
            update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ üòî")
            print(e)

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        for f in user_photos[user_id]:
            if os.path.exists(f):
                os.remove(f)
        if os.path.exists(output_path):
            os.remove(output_path)

        user_photos[user_id] = []


# ---- MAIN ----
def main():
    TOKEN = ""

    updater = Updater(TOKEN)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("reset", reset))
    dp.add_handler(MessageHandler(Filters.photo, handle_photo))

    updater.start_polling()
    updater.idle()


if __name__ == "__main__":
    main()
