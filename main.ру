import logging
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from PIL import Image
from io import BytesIO

# –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω
TOKEN = '–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê'

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_photos = {}

# –ö–æ–º–∞–Ω–¥–∞ /start
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üòé\n–•–æ—á–µ—à—å —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å —Ç–≤–æ–µ–π –ª—é–±–∏–º–æ–π –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—å—é? "
        "–û—Ç–ø—Ä–∞–≤—å —Å–Ω–∞—á–∞–ª–∞ —Å–≤–æ—ë —Ñ–æ—Ç–æ, –∞ –∑–∞—Ç–µ–º —Ñ–æ—Ç–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–∏, –∏ —è –æ–±—ä–µ–¥–∏–Ω—é –∏—Ö!"
    )
    user_photos[update.message.from_user.id] = []

# –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ
def handle_photo(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in user_photos:
        user_photos[user_id] = []

    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ —Å–ø–∏—Å–æ–∫
    photo_file = update.message.photo[-1].get_file()
    bio = BytesIO()
    photo_file.download(out=bio)
    bio.seek(0)
    user_photos[user_id].append(Image.open(bio))

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –¥–≤–∞ —Ñ–æ—Ç–æ, –æ–±—ä–µ–¥–∏–Ω—è–µ–º –∏—Ö
    if len(user_photos[user_id]) == 2:
        img1, img2 = user_photos[user_id]

        # –ü—Ä–∏–≤–æ–¥–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º—É —Ä–∞–∑–º–µ—Ä—É
        max_width = max(img1.width, img2.width)
        max_height = max(img1.height, img2.height)
        img1 = img1.resize((max_width, max_height))
        img2 = img2.resize((max_width, max_height))

        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
        combined = Image.new('RGB', (max_width*2, max_height))
        combined.paste(img1, (0,0))
        combined.paste(img2, (max_width,0))

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        output = BytesIO()
        output.name = 'celebrity_photo.jpg'
        combined.save(output, format='JPEG', quality=95)  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å —Ö–æ—Ä–æ—à–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º
        output.seek(0)
        update.message.reply_photo(photo=output)

        # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
        user_photos[user_id] = []
    else:
        update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ç–æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç–∏).")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
def error(update: Update, context: CallbackContext):
    logger.warning(f'Update {update} caused error {context.error}')

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(MessageHandler(Filters.photo, handle_photo))
    dp.add_error_handler(error)

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
